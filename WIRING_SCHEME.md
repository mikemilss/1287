# 🔌 СХЕМА ПОДКЛЮЧЕНИЯ RFID MATRIX 8×12

## 📋 СПИСОК КОМПОНЕНТОВ

### Основные модули:
- **1× ESP32 DevKit** (любая версия с 30+ GPIO)
- **1× PN532 NFC/RFID модуль** (с I2C интерфейсом)
- **2× HP4067 16-канальный аналоговый мультиплексор**
- **96× RFID антенны** 13.56MHz (круглые или квадратные катушки)

### Дополнительные компоненты:
- **2× Резистор 3.3kΩ** (подтягивающие для I2C)
- **Макетная плата** или **PCB** для монтажа
- **Соединительные провода** (желательно разных цветов)
- **Источник питания** 5V/3.3V с достаточным током

---

## 🔗 СХЕМА ПОДКЛЮЧЕНИЯ ESP32

```
                    ┌─────────────────────────────────────┐
                    │           ESP32 DevKit              │
                    │                                     │
     I2C BUS ────── │  GPIO21 (SDA) ●─────────────────── │ ──── PN532 SDA + 3.3kΩ ──── 3.3V
                    │  GPIO22 (SCL) ●─────────────────── │ ──── PN532 SCL + 3.3kΩ ──── 3.3V
                    │                                     │
     ROW MUX ────── │  GPIO4  (S0)  ●─────────────────── │ ──── HP4067 #1 S0
                    │  GPIO5  (S1)  ●─────────────────── │ ──── HP4067 #1 S1  
                    │  GPIO15 (S2)  ●─────────────────── │ ──── HP4067 #1 S2
                    │               ●                    │      HP4067 #1 S3 ──── GND
                    │                                     │
     COL MUX ────── │  GPIO18 (S0)  ●─────────────────── │ ──── HP4067 #2 S0
                    │  GPIO19 (S1)  ●─────────────────── │ ──── HP4067 #2 S1
                    │  GPIO23 (S2)  ●─────────────────── │ ──── HP4067 #2 S2
                    │  GPIO25 (S3)  ●─────────────────── │ ──── HP4067 #2 S3
                    │                                     │
     ENABLE ─────── │  GPIO26 (EN)  ●─────────────────── │ ──── HP4067 #1 EN + HP4067 #2 EN
                    │                                     │
     POWER ──────── │  3.3V   ●─────────────────────────│ ──── Общее питание модулей
                    │  GND    ●─────────────────────────│ ──── Общий GND
                    │                                     │
                    └─────────────────────────────────────┘
```

---

## 📡 ПОДКЛЮЧЕНИЕ PN532 RFID МОДУЛЯ

```
     PN532 MODULE                           ESP32
   ┌───────────────┐                   ┌─────────────┐
   │               │                   │             │
   │  VCC  ●───────┼─── 3.3V ─────────●  3.3V       │
   │  GND  ●───────┼─── GND ──────────●  GND        │
   │  SDA  ●───────┼─── 3.3kΩ ────────●  GPIO21     │ ── I2C Data
   │  SCL  ●───────┼─── 3.3kΩ ────────●  GPIO22     │ ── I2C Clock
   │               │   │               │             │
   │  IRQ  ●  (NC) │   │               │             │ ── Не подключать
   │  RST  ●  (NC) │   │               │             │ ── Не подключать
   │               │   │               │             │
   └───────────────┘   │               └─────────────┘
                       │
                      3.3V ── Подтягивающие резисторы

   ПЕРЕКЛЮЧАТЕЛИ PN532:
   SW1 = ON   (I2C режим)
   SW2 = OFF  (I2C режим)
```

---

## 🔀 ПОДКЛЮЧЕНИЕ МУЛЬТИПЛЕКСОРОВ HP4067

### HP4067 #1 (ROW MULTIPLEXER - СТРОКИ 0-7):

```
     HP4067 #1 (ROWS)                       ESP32
   ┌───────────────────┐               ┌─────────────┐
   │                   │               │             │
   │  VCC  ●───────────┼─── 3.3V ─────●  3.3V       │
   │  GND  ●───────────┼─── GND ──────●  GND        │
   │                   │               │             │
   │  S0   ●───────────┼───────────────●  GPIO4      │ ── Адрес бит 0
   │  S1   ●───────────┼───────────────●  GPIO5      │ ── Адрес бит 1
   │  S2   ●───────────┼───────────────●  GPIO15     │ ── Адрес бит 2
   │  S3   ●───────────┼─── GND                       │ ── Фиксированный 0
   │                   │               │             │
   │  EN   ●───────────┼───────────────●  GPIO26     │ ── Общий Enable
   │                   │               │             │
   │  SIG  ●───────────┼──── К PN532 ──●             │ ── Сигнальный пин
   │                   │               │             │
   │  Y0   ●───────────┼─── ROW 0 ─────●             │ ── Строка 0
   │  Y1   ●───────────┼─── ROW 1 ─────●             │ ── Строка 1
   │  Y2   ●───────────┼─── ROW 2 ─────●             │ ── Строка 2
   │  Y3   ●───────────┼─── ROW 3 ─────●             │ ── Строка 3
   │  Y4   ●───────────┼─── ROW 4 ─────●             │ ── Строка 4
   │  Y5   ●───────────┼─── ROW 5 ─────●             │ ── Строка 5
   │  Y6   ●───────────┼─── ROW 6 ─────●             │ ── Строка 6
   │  Y7   ●───────────┼─── ROW 7 ─────●             │ ── Строка 7
   │  Y8-Y15 (NC)      │                             │ ── Не используются
   │                   │                             │
   └───────────────────┘                             │
                                                     │
   АДРЕСАЦИЯ СТРОК:                                 │
   S2 S1 S0 = ROW                                   │
   0  0  0  = 0                                     │
   0  0  1  = 1                                     │
   0  1  0  = 2                                     │
   0  1  1  = 3                                     │
   1  0  0  = 4                                     │
   1  0  1  = 5                                     │
   1  1  0  = 6                                     │
   1  1  1  = 7                                     │
```

### HP4067 #2 (COLUMN MULTIPLEXER - СТОЛБЦЫ 0-11):

```
     HP4067 #2 (COLUMNS)                    ESP32
   ┌───────────────────┐               ┌─────────────┐
   │                   │               │             │
   │  VCC  ●───────────┼─── 3.3V ─────●  3.3V       │
   │  GND  ●───────────┼─── GND ──────●  GND        │
   │                   │               │             │
   │  S0   ●───────────┼───────────────●  GPIO18     │ ── Адрес бит 0
   │  S1   ●───────────┼───────────────●  GPIO19     │ ── Адрес бит 1
   │  S2   ●───────────┼───────────────●  GPIO23     │ ── Адрес бит 2
   │  S3   ●───────────┼───────────────●  GPIO25     │ ── Адрес бит 3
   │                   │               │             │
   │  EN   ●───────────┼───────────────●  GPIO26     │ ── Общий Enable
   │                   │               │             │
   │  SIG  ●───────────┼──── К PN532 ──●             │ ── Сигнальный пин
   │                   │               │             │
   │  Y0   ●───────────┼─── COL 0 ─────●             │ ── Столбец 0
   │  Y1   ●───────────┼─── COL 1 ─────●             │ ── Столбец 1
   │  Y2   ●───────────┼─── COL 2 ─────●             │ ── Столбец 2
   │  Y3   ●───────────┼─── COL 3 ─────●             │ ── Столбец 3
   │  Y4   ●───────────┼─── COL 4 ─────●             │ ── Столбец 4
   │  Y5   ●───────────┼─── COL 5 ─────●             │ ── Столбец 5
   │  Y6   ●───────────┼─── COL 6 ─────●             │ ── Столбец 6
   │  Y7   ●───────────┼─── COL 7 ─────●             │ ── Столбец 7
   │  Y8   ●───────────┼─── COL 8 ─────●             │ ── Столбец 8
   │  Y9   ●───────────┼─── COL 9 ─────●             │ ── Столбец 9
   │  Y10  ●───────────┼─── COL 10 ────●             │ ── Столбец 10
   │  Y11  ●───────────┼─── COL 11 ────●             │ ── Столбец 11
   │  Y12-Y15 (NC)     │                             │ ── Не используются
   │                   │                             │
   └───────────────────┘                             │
                                                     │
   АДРЕСАЦИЯ СТОЛБЦОВ:                              │
   S3 S2 S1 S0 = COL                                │
   0  0  0  0  = 0                                  │
   0  0  0  1  = 1                                  │
   0  0  1  0  = 2                                  │
   0  0  1  1  = 3                                  │
   0  1  0  0  = 4                                  │
   0  1  0  1  = 5                                  │
   0  1  1  0  = 6                                  │
   0  1  1  1  = 7                                  │
   1  0  0  0  = 8                                  │
   1  0  0  1  = 9                                  │
   1  0  1  0  = 10                                 │
   1  0  1  1  = 11                                 │
```

---

## 📊 МАТРИЦА АНТЕНН 8×12

```
         COLUMNS (HP4067 #2)
         0   1   2   3   4   5   6   7   8   9  10  11
       ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
   R 0 │ 0 │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │ 8 │ 9 │10 │11 │
   O   ├───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┤
   W 1 │12 │13 │14 │15 │16 │17 │18 │19 │20 │21 │22 │23 │
   S   ├───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┤
   ( 2 │24 │25 │26 │27 │28 │29 │30 │31 │32 │33 │34 │35 │
   H   ├───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┤
   P 3 │36 │37 │38 │39 │40 │41 │42 │43 │44 │45 │46 │47 │
   4   ├───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┤
   0 4 │48 │49 │50 │51 │52 │53 │54 │55 │56 │57 │58 │59 │
   6   ├───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┤
   7 5 │60 │61 │62 │63 │64 │65 │66 │67 │68 │69 │70 │71 │
   #   ├───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┤
   1 6 │72 │73 │74 │75 │76 │77 │78 │79 │80 │81 │82 │83 │
   )   ├───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┤
     7 │84 │85 │86 │87 │88 │89 │90 │91 │92 │93 │94 │95 │
       └───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┘

   ФОРМУЛА АДРЕСАЦИИ:
   Индекс ячейки = ROW × 12 + COL
   
   Примеры:
   Ячейка [0,0] = 0×12 + 0 = 0
   Ячейка [2,5] = 2×12 + 5 = 29
   Ячейка [7,11] = 7×12 + 11 = 95
```

---

## ⚡ СХЕМА ПИТАНИЯ

```
                        5V POWER SOURCE
                              │
                              ▼
                    ┌─────────────────┐
                    │   POWER SUPPLY  │
                    │      5V/3A      │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │  ESP32 DevKit   │ ── 3.3V регулятор встроен
                    │     3.3V OUT    │
                    └─────────┬───────┘
                              │ 3.3V
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
   ┌─────────┐         ┌─────────┐         ┌─────────┐
   │ PN532   │         │HP4067#1 │         │HP4067#2 │
   │ 3.3V    │         │ 3.3V    │         │ 3.3V    │
   └─────────┘         └─────────┘         └─────────┘

   ПОТРЕБЛЕНИЕ ТОКА:
   - ESP32: ~200mA
   - PN532: ~50mA  
   - HP4067 x2: ~2mA
   - ИТОГО: ~250mA (рекомендуется источник 1A+)
```

---

## 🔧 ПОШАГОВАЯ ИНСТРУКЦИЯ ПО СБОРКЕ

### Шаг 1: Подготовка компонентов
1. Проверьте все компоненты по списку
2. Настройте переключатели PN532: SW1=ON, SW2=OFF
3. Подготовьте макетную плату или PCB

### Шаг 2: Монтаж основных модулей
1. Установите ESP32 DevKit на макетную плату
2. Установите PN532 модуль 
3. Установите два HP4067 мультиплексора
4. Убедитесь в надежности контактов

### Шаг 3: Подключение питания
1. Соедините все VCC пины с 3.3V ESP32
2. Соедините все GND пины с GND ESP32  
3. Проверьте отсутствие коротких замыканий

### Шаг 4: I2C подключения
1. GPIO21 (SDA) → PN532 SDA
2. GPIO22 (SCL) → PN532 SCL
3. Припаяйте резисторы 3.3kΩ от SDA/SCL к 3.3V
4. **КРИТИЧНО:** Без подтягивающих резисторов I2C не будет работать!

### Шаг 5: Подключение управляющих сигналов мультиплексоров
```
ESP32        HP4067 #1 (ROWS)    HP4067 #2 (COLS)
GPIO4   ──── S0                  
GPIO5   ──── S1                  
GPIO15  ──── S2                  
GND     ──── S3                  
GPIO18  ────                     S0
GPIO19  ────                     S1  
GPIO23  ────                     S2
GPIO25  ────                     S3
GPIO26  ──── EN ─────────────── EN (общий)
```

### Шаг 6: Подключение антенн
1. Каждую антенну подключите к соответствующему выходу мультиплексоров
2. ROW антенны → Y0-Y7 HP4067 #1
3. COLUMN антенны → Y0-Y11 HP4067 #2  
4. Сигнальные выходы мультиплексоров → PN532

### Шаг 7: Проверка подключений
1. Визуально проверьте все соединения
2. Прозвоните мультиметром критичные линии
3. Убедитесь в отсутствии коротких замыканий

---

## 🧪 ТЕСТИРОВАНИЕ ПОДКЛЮЧЕНИЙ

### Тест 1: Базовая проверка питания
```cpp
void setup() {
  Serial.begin(115200);
  Serial.println("=== ТЕСТ ПИТАНИЯ ===");
  Serial.println("ESP32 запущен!");
  
  // Проверка GPIO
  pinMode(4, OUTPUT);
  digitalWrite(4, HIGH);
  delay(1000);
  digitalWrite(4, LOW);
  Serial.println("GPIO тест пройден");
}
```

### Тест 2: I2C сканирование
```cpp
#include <Wire.h>

void setup() {
  Serial.begin(115200);
  Wire.begin(21, 22); // SDA, SCL
  Serial.println("=== I2C СКАНЕР ===");
  
  for(int addr = 1; addr < 127; addr++) {
    Wire.beginTransmission(addr);
    if(Wire.endTransmission() == 0) {
      Serial.printf("Найдено устройство: 0x%02X\n", addr);
    }
  }
}
```

**Ожидаемый результат:** `Найдено устройство: 0x24` (PN532)

### Тест 3: Проверка мультиплексоров
```cpp
void testMultiplexers() {
  // Настройка пинов
  pinMode(4, OUTPUT);  // MUX1 S0
  pinMode(5, OUTPUT);  // MUX1 S1  
  pinMode(15, OUTPUT); // MUX1 S2
  pinMode(18, OUTPUT); // MUX2 S0
  pinMode(19, OUTPUT); // MUX2 S1
  pinMode(23, OUTPUT); // MUX2 S2
  pinMode(25, OUTPUT); // MUX2 S3
  pinMode(26, OUTPUT); // EN
  
  // Включение мультиплексоров
  digitalWrite(26, LOW); // EN активный LOW
  
  // Тест переключения адресов
  for(int addr = 0; addr < 8; addr++) {
    digitalWrite(4, addr & 0x01);
    digitalWrite(5, addr & 0x02);
    digitalWrite(15, addr & 0x04);
    Serial.printf("ROW адрес: %d\n", addr);
    delay(500);
  }
}
```

---

## ⚠️ ВАЖНЫЕ ПРИМЕЧАНИЯ

### 🔴 КРИТИЧНЫЕ МОМЕНТЫ:
1. **Подтягивающие резисторы I2C обязательны!** Без них PN532 не будет найден
2. **Переключатели PN532:** SW1=ON, SW2=OFF для I2C режима
3. **Общий EN пин:** GPIO26 управляет обоими мультиплексорами
4. **S3 для HP4067 #1:** Подключен к GND (экономия GPIO)

### 🟡 РЕКОМЕНДАЦИИ:
1. Используйте разные цвета проводов для разных сигналов
2. Подпишите все соединения на плате
3. Добавьте фильтрующие конденсаторы по питанию (100nF)
4. Используйте экранированные кабели для I2C при длинных соединениях

### 🟢 ОПТИМИЗАЦИИ:
1. Минимальная длина I2C проводов для стабильности
2. Качественная пайка для надежных контактов  
3. Раздельные питающие шины для аналоговой и цифровой частей
4. Тестовые точки для отладки на PCB

---

## 📞 ПОДДЕРЖКА И ДИАГНОСТИКА

При проблемах с подключением:

1. **PN532 не найден:**
   - Проверьте переключатели SW1=ON, SW2=OFF
   - Проверьте подтягивающие резисторы 3.3kΩ
   - Попробуйте питание PN532 от 5V вместо 3.3V

2. **Мультиплексоры не переключаются:**
   - Проверьте EN пин (должен быть LOW для активации)
   - Проверьте адресные пины S0-S3
   - Убедитесь в правильности питания 3.3V

3. **Система зависает:**
   - Добавьте фильтрующие конденсаторы
   - Проверьте стабильность питания
   - Уменьшите частоту I2C до 50kHz

**🎯 Схема готова к реализации!** 