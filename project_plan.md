# RFID Matrix 8×12 - Полный план архитектуры

## 1. Общая архитектура системы

### 1.1 Аппаратная часть
- **ESP32** - основной контроллер
- **PN532** - NFC/RFID модуль (I2C, адрес 0x24)
- **2x HP4067** - 16-канальные мультиплексоры для матрицы 8×12
- **96 RFID антенн** - организованы в матрицу 8 строк × 12 столбцов

### 1.2 Подключения
```
ESP32 GPIO21 (SDA) → PN532 SDA + подтягивающий резистор 3.3kΩ к 3.3V
ESP32 GPIO22 (SCL) → PN532 SCL + подтягивающий резистор 3.3kΩ к 3.3V
ESP32 GPIO2-5     → HP4067 #1 управляющие пины (S0-S3) - строки 0-7
ESP32 GPIO12-15   → HP4067 #2 управляющие пины (S0-S3) - столбцы 0-11
ESP32 GPIO16      → HP4067 #1 EN (активный LOW)
ESP32 GPIO17      → HP4067 #2 EN (активный LOW)
```

## 2. Программная архитектура

### 2.1 Принципы архитектуры
- **НЕБЛОКИРУЮЩАЯ** - никаких delay() или while() циклов
- **STATE MACHINE** - конечный автомат для управления состояниями
- **Милисекундное планирование** - все операции по таймерам
- **Быстрое сканирование** - оптимизация до максимальной скорости

### 2.2 Основные компоненты

#### A. Менеджер состояний (StateManager)
```cpp
enum SystemState {
    STATE_INIT,           // Инициализация системы
    STATE_SCAN_CELL,      // Сканирование текущей ячейки
    STATE_PROCESS_CARD,   // Обработка найденной карты
    STATE_SWITCH_CELL,    // Переключение на следующую ячейку
    STATE_UPDATE_DISPLAY, // Обновление дисплея
    STATE_ERROR           // Обработка ошибок
};
```

#### B. Матрица сканирования (ScanMatrix)
- Циклическое сканирование 96 ячеек
- Оптимизированное переключение мультиплексоров
- Кэширование состояний карт

#### C. RFID менеджер (RFIDManager)
- Неблокирующее чтение PN532
- Быстрая инициализация и конфигурация
- Обработка ошибок и переподключений

## 3. Временные характеристики (оптимизированные)

### 3.1 Тайминги
- **SCAN_DELAY_MS**: 5мс (вместо 40мс)
- **PN532_TIMEOUT**: 10мс (вместо 50мс)  
- **MUX_SETTLE_TIME_US**: 2мкс (вместо 10мкс)
- **DISPLAY_UPDATE_INTERVAL**: 2000мс

### 3.2 Производительность
- **Полный цикл**: 96 ячеек за ~0.5 секунды
- **FPS**: 2.0 кадра в секунду
- **Время на ячейку**: ~5.2мс

## 4. Структура файлов

```
src/
├── main.cpp              # Основной цикл, setup()
├── config.h              # Конфигурация и константы
├── state_manager.h/cpp   # Менеджер состояний
├── rfid_manager.h/cpp    # Управление PN532
├── scan_matrix.h/cpp     # Логика сканирования матрицы
├── multiplexer.h/cpp     # Управление HP4067
└── display_manager.h/cpp # Управление выводом данных
```

## 5. Алгоритм работы

### 5.1 Основной цикл (неблокирующий)
```cpp
void loop() {
    static unsigned long lastStateUpdate = 0;
    static unsigned long currentTime = millis();
    
    currentTime = millis();
    
    // Обновляем состояние только при необходимости
    if (currentTime - lastStateUpdate >= getStateDelay()) {
        stateManager.updateState();
        lastStateUpdate = currentTime;
    }
    
    // Минимальная задержка для стабильности
    delay(1);
}
```

### 5.2 Цикл сканирования
1. **Переключение ячейки** (2мкс)
2. **Стабилизация** (2мкс)  
3. **Сканирование PN532** (10мс timeout)
4. **Обработка результата** (1мс)
5. **Переход к следующей ячейке**

### 5.3 Обработка карт
- Детекция изменений (новая карта, удаленная карта)
- Кэширование UID для избежания повторной обработки
- Логирование событий

## 6. Оптимизации

### 6.1 Аппаратные оптимизации
- Подтягивающие резисторы 3.3kΩ на I2C
- Короткие провода к PN532
- Стабильное питание 3.3V

### 6.2 Программные оптимизации
- Минимальные тайминги везде где возможно
- Кэширование состояний
- Быстрое переключение мультиплексоров
- Неблокирующая архитектура

## 7. Обработка ошибок

### 7.1 PN532 ошибки
- Автоматическое переподключение
- Fallback на следующую ячейку при таймауте
- Счетчик ошибок и диагностика

### 7.2 Мультиплексор ошибки
- Проверка валидности адресов
- Резервирование времени на переключение

## 8. Мониторинг и диагностика

### 8.1 Метрики производительности
- FPS сканирования
- Количество успешных чтений
- Статистика ошибок
- Время выполнения операций

### 8.2 Логирование
- События обнаружения/удаления карт
- Ошибки инициализации
- Диагностическая информация

## 9. План реализации

### Фаза 1: Базовая инфраструктура
1. Создание config.h с оптимизированными константами
2. Реализация StateManager
3. Базовый main.cpp с неблокирующим циклом

### Фаза 2: RFID функциональность  
1. RFIDManager с быстрой инициализацией
2. Неблокирующее чтение карт
3. Обработка ошибок PN532

### Фаза 3: Матрица сканирования
1. Multiplexer управление
2. ScanMatrix логика
3. Оптимизация производительности

### Фаза 4: Интеграция и тестирование
1. DisplayManager для вывода
2. Полная интеграция всех компонентов
3. Тестирование и отладка

## 10. Ожидаемые результаты

- **Стабильная работа** без зависаний
- **Высокая производительность** - 2 FPS
- **Быстрая реакция** на события
- **Надежная обработка ошибок**
- **Легкое масштабирование** и модификация 